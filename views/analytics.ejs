<!DOCTYPE html> 
<html lang="en">
<%- include("partials/head") %>
<link href="/styles/roboto.css" rel="stylesheet"> 
<meta name="viewport" content="width=device-width, initial-scale=1"> 
<body style="margin-left:0px;margin-right:0px"> 

  <style>
    .md #app .list .item-content {
      width: 100%;
    }
    #app .md li li:last-child .item-inner:after, .md li:last-child li .item-inner:after {
      width: 100vw;
    }
    .md #app .list ul ul {
      padding-left: 0px;
    }
    .accordion-item-content {
      padding-left:16px;
    }
    #app .list .swipeout .item-inner {
      padding-left:8px;
    }
    #app .list .swipeout.item-content {
      padding-left:0px;
    }
    .list > ul > li.item-divider {
      height: 40px;
      background: #fff;
      margin-right: 16px;
      margin-top: 12px;
      line-height: 24px;
      font-size: 20px;
      font-weight:normal;
      color: #000000de;
      letter-spacing: 0.8px;
    } 
    .accordion-item > .item-link.item-content {
      font-size:19px;
    }
    .accordion-item .list .item-content .person-name {
      font-weight: 300;
    }
    .accordion-item-content .block-title {
      margin-top:0px;
      font-size: 18px;
      color: black;
    }
    .accordion-item-content .item-footer {
      font-size: 16px;
      color: black;
    }
  </style>
  <div id="app">
    <div class="view view-main">
    <link href="/styles/roboto.css" rel="stylesheet">
    <!--<link href="/styles/new.css" rel="stylesheet">-->
    <link rel="stylesheet" href = "/styles/icons.css">
      <div class="page page-current">
          <div class="page-content block">
            <div class="list no-hairlines">
              <ul>
                  <li class="list-item">
                    <div class="item-inner">
                        <div class="item-title">Homework by subject</div>
                    </div>
                    <div class="item-content">
                    <div class="list no-hairlines">
                      <ul>
                        <li>
                          <label class="item-checkbox item-content">
                            <input type="checkbox" name="homework-type" value="tests" checked/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Tests/graded homework</div>
                            </div>
                          </label>
                        </li>
                        <li>
                          <label class="item-checkbox item-content">
                            <input type="checkbox" name="homework-type" value="regular" checked/>
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                              <div class="item-title">Regular homework</div>
                            </div>
                          </label>
                        </li>
                      <div class="chart-container" style="position: relative;">
                       <canvas id="homework-subject-chart" height=350px width=350px></canvas>
                      </div>
                    </div>
                  </li>
                </ul>
            </div>
          </div>
        </div>
    </div>
  </div>
  <script src="/framework7/js/framework7.min.js"></script>
  <script src="/scripts/app.js"></script>
  <script defer src="/scripts/Chart.bundle.min.js"></script>
  <script src="/scripts/socket.io.js"></script>
  <script>
    function getCookie(cname) {
      var name = cname + "=";
      var decodedCookie = decodeURIComponent(document.cookie);
      var ca = decodedCookie.split(';');
      for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }
  </script>
  <script src="/scripts/raven.min.js" crossorigin="anonymous"></script>
  <script>
    // //DoNt toUcHa my eRRor rePoTer
    // Raven.config('https://6c425ba741364b1abb9832da6dde3908@sentry.io/1199491').install()
    // Raven.setUserContext({
    //   name: getCookie("name"),
    //   email: getCookie("email"),
    // })
  </script>
<script>
  let homeworkSubjectChart
  let gradedMode = 0
  const conn = io(location.origin,{secure: true})
  conn.on("connect_error",function(err){
    Raven.captureException(err)
  })
  const channel = location.pathname.substring(1).replace("/analytics","")
  conn.on("connect",function(){
    console.log("Conne")
  })

  //Db inited, can get data
  conn.on("ready",()=>{
    console.log("ready")
    conn.emit("homeworkSubjectData",{channel},(err,data)=>{
      if(err) throw err
      homeworkSubjectChart = renderHomeworkSubjectChart(data)
    })
  })

  const test = document.querySelector("input[type=checkbox][value=tests]")
  const regular = document.querySelector("input[type=checkbox][value=regular]")
  regular
  .addEventListener("change",e=>{
    const checked = e.target.checked
    if(checked){
      if(test.checked){
        gradedMode =0
      }else{
        gradedMode = -1
      }
    }else{
      if(test.checked){
        gradedMode = 1
      }else{
        gradedMode = 0
      }
    }
    conn.emit("homeworkSubjectData",{channel,graded:gradedMode},(err,data)=>{
      if(err) throw err
      homeworkSubjectChart = renderHomeworkSubjectChart(data)
    })
  })
  test
  .addEventListener("change",e=>{
    const checked = e.target.checked
    if(checked){
      if(regular.checked){
        gradedMode = 0
      }else{
        gradedMode = 1
      }
    }else{
      if(regular.checked){
        gradedMode = -1
      }else{
        gradedMode = 0
      }
    }
    conn.emit("homeworkSubjectData",{channel,graded:gradedMode},(err,data)=>{
      if(err) throw err
      homeworkSubjectChart = renderHomeworkSubjectChart(data)
    })
  })

  const getKeysAndValues = array =>{
    const result = [[],[]]
    for(const elem of array){
      result[0].push(elem[0])
      result[1].push(elem[1])
    }
    return result
  }
  const sumArr = arr =>{
    let sum = 0
    for(const val of arr){
      sum += val
    }
    return sum
  }
  const default_colors = ['#3366CC','#DC3912','#FF9900','#109618','#990099','#3B3EAC','#0099C6','#DD4477','#66AA00','#B82E2E','#316395','#994499','#22AA99','#AAAA11','#6633CC','#E67300','#8B0707','#329262','#5574A6','#3B3EAC']
  const getColors = array => default_colors.slice(0,array.length)
  function renderHomeworkSubjectChart(data){
    const split = getKeysAndValues(data)
    const keys = split[0]
    const values = split[1]
    if(homeworkSubjectChart){
      homeworkSubjectChart.data = {
        labels:keys,
        datasets:[{
          data:values,
          backgroundColor:getColors(keys)
        }]
      }
      homeworkSubjectChart.update()
      return homeworkSubjectChart
    }
    const canvas = document.getElementById("homework-subject-chart")
    const chart = new Chart(canvas,{
      type:"pie",
      data:{
        labels:keys,
        datasets:[{
          data:values,
          backgroundColor:getColors(keys)
        }]
      },
      options:{
        legend:{
          position:"right",
          labels:{
            generateLabels:chart=>{
              const {data} = chart
              const values = data.datasets[0].data
              const total = sumArr(values)
              const colors = data.datasets[0].backgroundColor
              const labels = data.labels
              const res = []
              for(const label of labels){
                const labelObj = {}
                const num = res.length
                const value = values[num]
                const percentage = Math.floor((value/total)*100)
                labelObj.text = label + ` (${percentage}%)`
                labelObj.fillStyle = colors[num]
                res.push(labelObj)
              }
              console.log(res)
              return res
            }
          }
        }
      }
    })
    return chart
  }
</script>
<script>
  const mainView = Framework7App.views.create('.view-main')
</script>
<link rel="stylesheet" href="/framework7/css/framework7.min.css"> 
</body>
</html>
